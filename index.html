<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Commerce Customer App</title>
    <style>
        /* CSS STYLING */
        :root {
            --primary: #ef4444; /* Red 500 */
            --primary-dark: #dc2626; /* Red 600 */
            --secondary: #3b82f6; /* Blue 500 */
            --background: #f9fafb; /* Gray 50 */
            --text-color: #1f2937; /* Gray 900 */
            --light-gray: #e5e7eb; /* Gray 200 */
            --white: #ffffff;
            --dark-gray: #4b5563; /* Gray 600 */
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --border-radius: 0.375rem; /* 6px */
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            background-color: var(--background);
            color: var(--text-color);
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 60px; /* Space for fixed bottom nav */
        }

        /* Utility Classes */
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 15px;
        }

        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }
        .font-bold { font-weight: bold; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        .my-4 { margin-top: 1rem; margin-bottom: 1rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mt-4 { margin-top: 1rem; }
        .p-2 { padding: 0.5rem; }
        .p-4 { padding: 1rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .rounded-md { border-radius: var(--border-radius); }
        .shadow-sm { box-shadow: var(--shadow); }
        .bg-white { background-color: var(--white); }
        .text-primary { color: var(--primary); }
        .text-secondary { color: var(--secondary); }
        .hidden { display: none !important; }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.25rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s ease-in-out;
            border: none;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        .btn-primary {
            background-color: var(--primary);
            color: var(--white);
        }
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        .btn-secondary {
            background-color: var(--secondary);
            color: var(--white);
        }
        .btn-secondary:hover {
            background-color: #2563eb; /* Blue 600 */
        }
        .btn-outline {
            background-color: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
        }
        .btn-outline:hover {
            background-color: var(--primary);
            color: var(--white);
        }
        .btn-sm {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
        }

        /* Header */
        header {
            background-color: var(--white);
            padding: 1rem;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .header-left, .header-right {
            display: flex;
            align-items: center;
        }
        .header-logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }
        .search-bar {
            flex-grow: 1;
            margin: 0 1rem;
            position: relative;
        }
        .search-bar input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-size: 1rem;
        }
        .search-bar button {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--dark-gray);
            cursor: pointer;
            font-size: 1rem;
        }
        .icon-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--dark-gray);
            margin-left: 0.5rem;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--white);
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0;
            z-index: 1000;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--dark-gray);
            text-decoration: none;
            font-size: 0.75rem;
            padding: 0.25rem 0;
            flex: 1;
        }
        .nav-item.active {
            color: var(--primary);
        }
        .nav-item i {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }

        /* Home Screen */
        .banner-slider {
            overflow: hidden;
            border-radius: var(--border-radius);
            margin: 1rem 0;
            position: relative;
        }
        .banner-wrapper {
            display: flex;
            transition: transform 0.5s ease-in-out;
        }
        .banner-slide {
            min-width: 100%;
            height: 180px; /* Fixed height for banners */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        .banner-dots {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
        }
        .banner-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.5);
            margin: 0 4px;
            cursor: pointer;
        }
        .banner-dot.active {
            background-color: var(--white);
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .category-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            padding: 1rem 0.5rem;
            cursor: pointer;
        }
        .category-card img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin-bottom: 0.5rem;
        }
        .category-card span {
            font-size: 0.875rem;
            font-weight: bold;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .product-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            position: relative;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            text-decoration: none;
            color: inherit;
        }
        .product-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        .product-card-info {
            padding: 0.75rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .product-card-title {
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .product-card-price {
            color: var(--primary);
            font-size: 1rem;
            font-weight: bold;
            margin-top: auto; /* Pushes price to bottom */
        }
        .product-card-heart {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            padding: 5px;
            cursor: pointer;
            font-size: 1rem;
            color: var(--dark-gray);
        }
        .product-card-heart.favorited {
            color: var(--primary);
        }

        /* Product Details Screen */
        .product-detail-images {
            overflow: hidden;
            position: relative;
            margin-bottom: 1rem;
        }
        .product-detail-image-wrapper {
            display: flex;
            transition: transform 0.5s ease-in-out;
        }
        .product-detail-image-slide {
            min-width: 100%;
            height: 300px;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            background-color: var(--white);
        }
        .product-detail-dots {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
        }
        .product-detail-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.3);
            margin: 0 4px;
            cursor: pointer;
        }
        .product-detail-dot.active {
            background-color: var(--primary);
        }

        .product-detail-info {
            padding: 1rem;
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        .product-detail-name {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .product-detail-price {
            font-size: 1.25rem;
            color: var(--primary);
            font-weight: bold;
            margin-bottom: 1rem;
        }
        .product-detail-sizes label {
            display: inline-block;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            margin-right: 0.5rem;
            cursor: pointer;
        }
        .product-detail-sizes input[type="radio"] {
            display: none;
        }
        .product-detail-sizes input[type="radio"]:checked + label {
            background-color: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }
        .product-detail-description {
            margin-top: 1rem;
            line-height: 1.5;
            color: var(--dark-gray);
        }
        .product-detail-actions {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            margin-top: 1.5rem;
            padding: 0 1rem;
        }
        .product-detail-actions .btn {
            flex: 1;
        }

        /* Cart Screen */
        .cart-item {
            display: flex;
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 1rem;
            padding: 0.75rem;
            align-items: center;
        }
        .cart-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: var(--border-radius);
            margin-right: 1rem;
        }
        .cart-item-details {
            flex-grow: 1;
        }
        .cart-item-title {
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        .cart-item-price {
            color: var(--primary);
            font-weight: bold;
            font-size: 0.9rem;
        }
        .cart-item-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .cart-item-qty-selector {
            display: flex;
            align-items: center;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
        }
        .cart-item-qty-selector button {
            background-color: var(--light-gray);
            border: none;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            font-size: 1rem;
        }
        .cart-item-qty-selector span {
            padding: 0.25rem 0.5rem;
            min-width: 20px;
            text-align: center;
        }
        .cart-item-remove-btn {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 1.2rem;
            margin-left: 0.5rem;
        }
        .cart-summary {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1rem;
            margin-top: 1rem;
        }
        .cart-summary div {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        .cart-summary .total {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--primary);
        }

        /* Profile Screen */
        .profile-section {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 1rem;
            background-color: var(--light-gray);
        }
        .profile-menu button {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 1rem;
            background: none;
            border: none;
            text-align: left;
            font-size: 1rem;
            color: var(--text-color);
            border-bottom: 1px solid var(--light-gray);
            cursor: pointer;
        }
        .profile-menu button:last-child {
            border-bottom: none;
        }
        .profile-menu button i {
            margin-right: 1rem;
            color: var(--dark-gray);
        }

        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-size: 1rem;
            box-sizing: border-box; /* Include padding in width */
        }
        .form-group input[type="file"] {
            padding: 0.5rem 0;
        }
        .form-actions {
            margin-top: 1.5rem;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* Order Tracking Timeline */
        .timeline {
            position: relative;
            margin: 2rem 0;
            padding: 0 1rem;
        }
        .timeline::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: var(--light-gray);
        }
        .timeline-item {
            position: relative;
            margin-bottom: 1.5rem;
            padding-left: 40px;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 12px;
            top: 0;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background-color: var(--light-gray);
            border: 2px solid var(--white);
            box-shadow: 0 0 0 2px var(--light-gray);
        }
        .timeline-item.active::before {
            background-color: var(--primary);
            box-shadow: 0 0 0 2px var(--primary);
        }
        .timeline-item-title {
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        .timeline-item-date {
            font-size: 0.85rem;
            color: var(--dark-gray);
        }

        /* Reusable Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: var(--white);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            max-width: 90%;
            width: 400px;
            text-align: center;
        }
        .modal-header {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }
        .modal-body {
            margin-bottom: 1.5rem;
            color: var(--dark-gray);
        }
        .modal-footer {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        /* Filters */
        .filter-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            text-align: left;
        }
        .filter-options label {
            display: block;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .filter-options select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
        }

        /* Media Queries for larger screens (tablet and desktop) */
        @media (min-width: 768px) {
            .container {
                max-width: 720px;
            }
            .product-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            .product-detail-actions {
                justify-content: center;
            }
            .product-detail-info {
                padding: 2rem;
            }
            .cart-item {
                padding: 1rem;
            }
            .cart-item img {
                width: 100px;
                height: 100px;
            }
            .bottom-nav {
                display: none; /* Hide bottom nav on larger screens, typically a sidebar or top nav would take over */
            }
            body {
                padding-bottom: 0;
            }
            header {
                padding: 1rem 2rem;
            }
        }

        @media (min-width: 1024px) {
            .container {
                max-width: 960px;
            }
            .product-grid {
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            }
        }
    </style>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Razorpay Checkout Script (client-side) -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body>
    <header>
        <div class="header-left">
            <span class="header-logo">E-Shop</span>
        </div>
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Search products...">
            <button id="searchButton"><i class="fas fa-search"></i></button>
        </div>
        <div class="header-right">
            <!-- Icons can be added here, e.g., notifications -->
        </div>
    </header>

    <main class="container">
        <!-- Home Screen -->
        <section id="homeScreen" class="screen">
            <div class="banner-slider">
                <div class="banner-wrapper" id="bannerSlider">
                    <!-- Banners will be injected here -->
                </div>
                <div class="banner-dots" id="bannerDots"></div>
            </div>

            <h2 class="text-xl font-bold my-4">Categories</h2>
            <div class="category-grid" id="categoryGrid">
                <!-- Categories will be injected here -->
            </div>

            <div class="flex justify-between items-center my-4">
                <h2 class="text-xl font-bold">Featured Products</h2>
                <button id="filterSortBtn" class="btn btn-outline btn-sm">
                    <i class="fas fa-filter"></i> Filter & Sort
                </button>
            </div>
            <div class="product-grid" id="productGrid">
                <!-- Products will be injected here -->
            </div>
        </section>

        <!-- Search Results Screen -->
        <section id="searchResultsScreen" class="screen hidden">
            <h2 class="text-xl font-bold my-4">Search Results for "<span id="searchTermDisplay"></span>"</h2>
            <div class="product-grid" id="searchResultsGrid">
                <!-- Search results will be injected here -->
            </div>
            <p id="noSearchResults" class="text-center hidden">No products found for this search term.</p>
        </section>

        <!-- Product Details Screen -->
        <section id="productDetailsScreen" class="screen hidden">
            <div class="product-detail-images">
                <div class="product-detail-image-wrapper" id="productImageSlider">
                    <!-- Product images will be injected here -->
                </div>
                <div class="product-detail-dots" id="productImageDots"></div>
            </div>

            <div class="product-detail-info">
                <h1 class="product-detail-name" id="productDetailName"></h1>
                <p class="product-detail-price" id="productDetailPrice"></p>
                <div class="product-detail-description">
                    <h3 class="font-bold mb-2">Description</h3>
                    <p id="productDetailDescription"></p>
                </div>

                <div class="my-4">
                    <h3 class="font-bold mb-2">Sizes</h3>
                    <div class="product-detail-sizes" id="productDetailSizes">
                        <!-- Sizes will be injected here -->
                    </div>
                </div>

                <div class="product-detail-actions">
                    <button class="btn btn-secondary" id="addToCartBtn"><i class="fas fa-cart-plus"></i> Add to Cart</button>
                    <button class="btn btn-primary" id="buyNowBtn"><i class="fas fa-credit-card"></i> Buy Now</button>
                    <button class="btn btn-outline" id="tryOnBtn"><i class="fas fa-vr-cardboard"></i> Try On You</button>
                </div>
            </div>
        </section>

        <!-- Cart Screen -->
        <section id="cartScreen" class="screen hidden">
            <h2 class="text-xl font-bold my-4">Your Cart</h2>
            <div id="cartItemsContainer">
                <!-- Cart items will be injected here -->
                <p class="text-center" id="emptyCartMessage">Your cart is empty.</p>
            </div>
            <div id="cartSummary" class="cart-summary hidden">
                <div><span>Subtotal</span> <span id="cartSubtotal">₹0.00</span></div>
                <div><span>Shipping</span> <span>₹50.00</span></div>
                <div class="total"><span>Total</span> <span id="cartTotal">₹0.00</span></div>
                <button class="btn btn-primary w-full mt-4" id="checkoutBtn">Proceed to Checkout</button>
            </div>
        </section>

        <!-- Profile Screen -->
        <section id="profileScreen" class="screen hidden">
            <!-- Login/Signup View -->
            <div id="authView" class="profile-section">
                <h2 class="text-xl font-bold mb-4 text-center" id="authHeader">Login</h2>
                <form id="authForm" class="flex flex-col gap-4">
                    <div class="form-group">
                        <label for="authEmail">Email</label>
                        <input type="email" id="authEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label for="authPassword">Password</label>
                        <input type="password" id="authPassword" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="btn btn-primary" id="authSubmitBtn">Login</button>
                    <p class="text-center mt-2">
                        <span id="toggleAuthModeText">Don't have an account?</span>
                        <button type="button" class="text-primary font-bold ml-1" id="toggleAuthModeBtn">Sign Up</button>
                    </p>
                </form>
            </div>

            <!-- Profile View -->
            <div id="profileView" class="hidden">
                <div class="profile-section flex flex-col items-center">
                    <img id="profileAvatarDisplay" src="https://via.placeholder.com/80?text=P" alt="Profile Avatar" class="profile-avatar">
                    <input type="file" id="avatarUploadInput" accept="image/*" class="hidden">
                    <button class="btn btn-sm btn-outline mt-2" id="changeAvatarBtn">Change Avatar</button>
                    <h2 class="text-xl font-bold mt-4" id="profileUserName"></h2>
                    <p class="text-dark-gray" id="profileUserEmail"></p>
                </div>

                <div class="profile-section profile-menu">
                    <button id="myOrdersBtn"><i class="fas fa-box"></i> My Orders</button>
                    <button id="manageAddressBtn"><i class="fas fa-map-marker-alt"></i> Manage Address</button>
                    <button id="contactUsBtn"><i class="fas fa-headset"></i> Contact Us</button>
                    <button id="logoutBtn" class="text-primary"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </div>
        </section>

        <!-- My Orders Screen -->
        <section id="myOrdersScreen" class="screen hidden">
            <h2 class="text-xl font-bold my-4">My Orders</h2>
            <div id="ordersList">
                <p class="text-center" id="emptyOrdersMessage">You haven't placed any orders yet.</p>
                <!-- Orders will be injected here -->
            </div>
        </section>

        <!-- Track Order Screen -->
        <section id="trackOrderScreen" class="screen hidden">
            <h2 class="text-xl font-bold my-4">Track Order <span id="trackOrderIdDisplay"></span></h2>
            <div class="timeline" id="orderTimeline">
                <!-- Timeline items will be injected here -->
            </div>
            <div id="cancelOrderSection" class="text-center my-4">
                <button id="cancelOrderBtn" class="btn btn-primary btn-sm">Cancel Order</button>
            </div>
        </section>

        <!-- Delivery Address & Payment Screen -->
        <section id="deliveryAddressScreen" class="screen hidden">
            <h2 class="text-xl font-bold my-4">Delivery & Payment</h2>
            <div class="profile-section">
                <form id="addressForm">
                    <div class="form-group">
                        <label for="fullName">Full Name</label>
                        <input type="text" id="fullName" placeholder="Your Full Name" required>
                    </div>
                    <div class="form-group">
                        <label for="mobileNumber">Mobile Number</label>
                        <input type="text" id="mobileNumber" placeholder="Your Mobile Number" required>
                    </div>
                    <div class="form-group">
                        <label for="pincode">Pincode</label>
                        <input type="text" id="pincode" placeholder="Pincode" maxlength="6" required>
                    </div>
                    <div class="form-group">
                        <label for="addressLine1">Address Line 1</label>
                        <input type="text" id="addressLine1" placeholder="House No., Building Name" required>
                    </div>
                    <div class="form-group">
                        <label for="addressLine2">Address Line 2 (Optional)</label>
                        <input type="text" id="addressLine2" placeholder="Road Name, Area, Colony">
                    </div>
                    <div class="form-group">
                        <label for="city">City</label>
                        <input type="text" id="city" placeholder="City" readonly required>
                    </div>
                    <div class="form-group">
                        <label for="state">State</label>
                        <input type="text" id="state" placeholder="State" readonly required>
                    </div>
                    <button type="submit" class="btn btn-primary w-full">Save Address</button>
                </form>
            </div>

            <div class="profile-section mt-4">
                <h3 class="text-lg font-bold mb-4">Payment Method</h3>
                <div class="form-group">
                    <label class="flex items-center mb-2">
                        <input type="radio" name="paymentMethod" value="COD" checked>
                        <span class="ml-2">Cash on Delivery</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="paymentMethod" value="Online">
                        <span class="ml-2">Online Payment (Razorpay)</span>
                    </label>
                </div>
                <button class="btn btn-primary w-full mt-4" id="placeOrderBtn">Place Order</button>
            </div>
        </section>

        <!-- Order Confirmation Screen -->
        <section id="orderConfirmationScreen" class="screen hidden text-center p-8">
            <i class="fas fa-check-circle text-primary text-6xl mb-4"></i>
            <h2 class="text-3xl font-bold text-primary mb-2">Order Confirmed!</h2>
            <p class="text-lg mb-4">Thank you for your purchase. Your order <span id="confirmedOrderId"></span> has been placed successfully.</p>
            <button class="btn btn-secondary" onclick="showScreen('homeScreen')">Continue Shopping</button>
        </section>

        <!-- Favorites (Wishlist) Screen -->
        <section id="favoritesScreen" class="screen hidden">
            <h2 class="text-xl font-bold my-4">Your Wishlist</h2>
            <div class="product-grid" id="wishlistGrid">
                <!-- Wishlist items will be injected here -->
            </div>
            <p class="text-center" id="emptyWishlistMessage">Your wishlist is empty.</p>
        </section>

        <!-- Modals -->
        <div id="alertModal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="modal-header" id="alertModalHeader">Alert</div>
                <div class="modal-body" id="alertModalBody"></div>
                <div class="modal-footer">
                    <button class="btn btn-primary" id="alertModalCloseBtn">OK</button>
                </div>
            </div>
        </div>

        <div id="confirmModal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="modal-header" id="confirmModalHeader">Confirm</div>
                <div class="modal-body" id="confirmModalBody">Are you sure?</div>
                <div class="modal-footer">
                    <button class="btn btn-outline" id="confirmModalCancelBtn">Cancel</button>
                    <button class="btn btn-primary" id="confirmModalConfirmBtn">Confirm</button>
                </div>
            </div>
        </div>

        <div id="filterSortModal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="modal-header">Filter & Sort</div>
                <div class="modal-body filter-options">
                    <div class="form-group">
                        <label for="filterCategory">Category</label>
                        <select id="filterCategory">
                            <option value="">All Categories</option>
                            <!-- Categories will be injected here -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="sortBy">Sort By</label>
                        <select id="sortBy">
                            <option value="none">None</option>
                            <option value="price_asc">Price: Low to High</option>
                            <option value="price_desc">Price: High to Low</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" id="filterSortCancelBtn">Cancel</button>
                    <button class="btn btn-primary" id="filterSortApplyBtn">Apply</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="#" class="nav-item active" id="navHome">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="#" class="nav-item" id="navWishlist">
            <i class="fas fa-heart"></i>
            <span>Wishlist</span>
        </a>
        <a href="#" class="nav-item" id="navCart">
            <i class="fas fa-shopping-cart"></i>
            <span>Cart</span>
        </a>
        <a href="#" class="nav-item" id="navProfile">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </a>
    </nav>

    <script type="module">
        // JAVASCRIPT FUNCTIONALITY
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

        const SUPABASE_URL = "YOUR_SUPABASE_PROJECT_URL"; // 🚀🚀🚀 Yahan apna Supabase Project URL daalo
        const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY"; // 🚀🚀🚀 Yahan apna Supabase anon/public key daalo
        const RAZORPAY_KEY_ID = "YOUR_RAZORPAY_KEY_ID"; // 🚀🚀🚀 yahan apna Razorpay key daalo

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let currentProduct = null;
        let userCart = [];
        let userWishlist = [];
        let allProducts = [];
        let currentFilterCategory = '';
        let currentSortBy = 'none';

        // --- UI Elements ---
        const screens = document.querySelectorAll('.screen');
        const bottomNavItems = document.querySelectorAll('.nav-item');
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const searchTermDisplay = document.getElementById('searchTermDisplay');
        const productGrid = document.getElementById('productGrid');
        const categoryGrid = document.getElementById('categoryGrid');
        const searchResultsGrid = document.getElementById('searchResultsGrid');
        const noSearchResults = document.getElementById('noSearchResults');
        const productImageSlider = document.getElementById('productImageSlider');
        const productImageDots = document.getElementById('productImageDots');
        const productDetailName = document.getElementById('productDetailName');
        const productDetailPrice = document.getElementById('productDetailPrice');
        const productDetailDescription = document.getElementById('productDetailDescription');
        const productDetailSizes = document.getElementById('productDetailSizes');
        const addToCartBtn = document.getElementById('addToCartBtn');
        const buyNowBtn = document.getElementById('buyNowBtn');
        const tryOnBtn = document.getElementById('tryOnBtn');
        const cartItemsContainer = document.getElementById('cartItemsContainer');
        const emptyCartMessage = document.getElementById('emptyCartMessage');
        const cartSummary = document.getElementById('cartSummary');
        const cartSubtotal = document.getElementById('cartSubtotal');
        const cartTotal = document.getElementById('cartTotal');
        const checkoutBtn = document.getElementById('checkoutBtn');
        const authView = document.getElementById('authView');
        const profileView = document.getElementById('profileView');
        const authHeader = document.getElementById('authHeader');
        const authForm = document.getElementById('authForm');
        const authEmail = document.getElementById('authEmail');
        const authPassword = document.getElementById('authPassword');
        const authSubmitBtn = document.getElementById('authSubmitBtn');
        const toggleAuthModeText = document.getElementById('toggleAuthModeText');
        const toggleAuthModeBtn = document.getElementById('toggleAuthModeBtn');
        const profileAvatarDisplay = document.getElementById('profileAvatarDisplay');
        const avatarUploadInput = document.getElementById('avatarUploadInput');
        const changeAvatarBtn = document.getElementById('changeAvatarBtn');
        const profileUserName = document.getElementById('profileUserName');
        const profileUserEmail = document.getElementById('profileUserEmail');
        const myOrdersBtn = document.getElementById('myOrdersBtn');
        const manageAddressBtn = document.getElementById('manageAddressBtn');
        const contactUsBtn = document.getElementById('contactUsBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const ordersList = document.getElementById('ordersList');
        const emptyOrdersMessage = document.getElementById('emptyOrdersMessage');
        const orderTimeline = document.getElementById('orderTimeline');
        const trackOrderIdDisplay = document.getElementById('trackOrderIdDisplay');
        const cancelOrderSection = document.getElementById('cancelOrderSection');
        const cancelOrderBtn = document.getElementById('cancelOrderBtn');
        const addressForm = document.getElementById('addressForm');
        const pincodeInput = document.getElementById('pincode');
        const cityInput = document.getElementById('city');
        const stateInput = document.getElementById('state');
        const fullNameInput = document.getElementById('fullName');
        const mobileNumberInput = document.getElementById('mobileNumber');
        const addressLine1Input = document.getElementById('addressLine1');
        const addressLine2Input = document.getElementById('addressLine2');
        const paymentMethodRadios = document.querySelectorAll('input[name="paymentMethod"]');
        const placeOrderBtn = document.getElementById('placeOrderBtn');
        const confirmedOrderId = document.getElementById('confirmedOrderId');
        const wishlistGrid = document.getElementById('wishlistGrid');
        const emptyWishlistMessage = document.getElementById('emptyWishlistMessage');
        const bannerSlider = document.getElementById('bannerSlider');
        const bannerDots = document.getElementById('bannerDots');

        const alertModal = document.getElementById('alertModal');
        const alertModalHeader = document.getElementById('alertModalHeader');
        const alertModalBody = document.getElementById('alertModalBody');
        const alertModalCloseBtn = document.getElementById('alertModalCloseBtn');

        const confirmModal = document.getElementById('confirmModal');
        const confirmModalHeader = document.getElementById('confirmModalHeader');
        const confirmModalBody = document.getElementById('confirmModalBody');
        const confirmModalCancelBtn = document.getElementById('confirmModalCancelBtn');
        const confirmModalConfirmBtn = document.getElementById('confirmModalConfirmBtn');

        const filterSortModal = document.getElementById('filterSortModal');
        const filterCategorySelect = document.getElementById('filterCategory');
        const sortBySelect = document.getElementById('sortBy');
        const filterSortCancelBtn = document.getElementById('filterSortCancelBtn');
        const filterSortApplyBtn = document.getElementById('filterSortApplyBtn');
        const filterSortBtn = document.getElementById('filterSortBtn');


        // --- Modals Helper Functions ---
        function showAlert(title, message) {
            alertModalHeader.textContent = title;
            alertModalBody.textContent = message;
            alertModal.classList.remove('hidden');
        }

        alertModalCloseBtn.addEventListener('click', () => {
            alertModal.classList.add('hidden');
        });

        function showConfirm(title, message, onConfirm) {
            confirmModalHeader.textContent = title;
            confirmModalBody.textContent = message;
            confirmModal.classList.remove('hidden');

            confirmModalConfirmBtn.onclick = () => {
                confirmModal.classList.add('hidden');
                onConfirm();
            };
            confirmModalCancelBtn.onclick = () => {
                confirmModal.classList.add('hidden');
            };
        }

        // --- Screen Navigation ---
        function showScreen(screenId) {
            screens.forEach(screen => {
                if (screen.id === screenId) {
                    screen.classList.remove('hidden');
                } else {
                    screen.classList.add('hidden');
                }
            });
            // Update active state for bottom nav
            bottomNavItems.forEach(item => item.classList.remove('active'));
            if (screenId === 'homeScreen') document.getElementById('navHome').classList.add('active');
            else if (screenId === 'favoritesScreen') document.getElementById('navWishlist').classList.add('active');
            else if (screenId === 'cartScreen') document.getElementById('navCart').classList.add('active');
            else if (screenId === 'profileScreen' || screenId === 'myOrdersScreen' || screenId === 'deliveryAddressScreen') document.getElementById('navProfile').classList.add('active');
        }

        // --- Supabase Authentication ---
        let isSignUpMode = false;

        async function handleAuthSubmit(event) {
            event.preventDefault();
            const email = authEmail.value;
            const password = authPassword.value;

            if (isSignUpMode) {
                const { data, error } = await supabase.auth.signUp({ email, password });
                if (error) {
                    showAlert("Sign Up Error", error.message);
                } else {
                    showAlert("Sign Up Successful", "Please check your email to confirm your account.");
                    // Optionally switch to login mode after signup
                    isSignUpMode = false;
                    updateAuthUI();
                }
            } else {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) {
                    showAlert("Login Error", error.message);
                } else {
                    showAlert("Login Successful", "Welcome back!");
                    // onAuthStateChange will handle UI update
                }
            }
        }

        function updateAuthUI() {
            authHeader.textContent = isSignUpMode ? "Sign Up" : "Login";
            authSubmitBtn.textContent = isSignUpMode ? "Sign Up" : "Login";
            toggleAuthModeText.textContent = isSignUpMode ? "Already have an account?" : "Don't have an account?";
            toggleAuthModeBtn.textContent = isSignUpMode ? "Login" : "Sign Up";
        }

        toggleAuthModeBtn.addEventListener('click', () => {
            isSignUpMode = !isSignUpMode;
            updateAuthUI();
        });

        authForm.addEventListener('submit', handleAuthSubmit);

        supabase.auth.onAuthStateChange(async (event, session) => {
            if (session) {
                currentUser = session.user;
                authView.classList.add('hidden');
                profileView.classList.remove('hidden');
                profileUserName.textContent = currentUser.user_metadata?.full_name || currentUser.email;
                profileUserEmail.textContent = currentUser.email;
                profileAvatarDisplay.src = currentUser.user_metadata?.avatar_url || 'https://via.placeholder.com/80?text=P';
                await fetchUserData(); // Fetch user-specific data like cart, wishlist, address
                showScreen('profileScreen'); // Stay on profile if just logged in
            } else {
                currentUser = null;
                authView.classList.remove('hidden');
                profileView.classList.add('hidden');
                // Clear user-specific data
                userCart = [];
                userWishlist = [];
                renderCart();
                renderWishlist();
                showScreen('profileScreen'); // Show login screen
            }
        });

        async function fetchUserData() {
            if (!currentUser) return;

            // Fetch user profile (for full_name, avatar_url if not in user_metadata)
            const { data: userProfile, error: profileError } = await supabase
                .from('users')
                .select('full_name, avatar_url')
                .eq('id', currentUser.id)
                .single();

            if (userProfile) {
                profileUserName.textContent = userProfile.full_name || currentUser.email;
                profileAvatarDisplay.src = userProfile.avatar_url || 'https://via.placeholder.com/80?text=P';
            }

            // Fetch cart items
            const { data: cartData, error: cartError } = await supabase
                .from('carts')
                .select('*, products(id, title, price, image_urls)')
                .eq('user_id', currentUser.id);

            if (cartError) console.error('Error fetching cart:', cartError.message);
            else userCart = cartData.map(item => ({
                ...item,
                product: item.products
            }));
            renderCart();

            // Fetch wishlist items
            const { data: wishlistData, error: wishlistError } = await supabase
                .from('wishlists')
                .select('*, products(id, title, price, image_urls)')
                .eq('user_id', currentUser.id);

            if (wishlistError) console.error('Error fetching wishlist:', wishlistError.message);
            else userWishlist = wishlistData.map(item => ({
                ...item,
                product: item.products
            }));
            renderWishlist();

            // Fetch address
            const { data: addressData, error: addressError } = await supabase
                .from('addresses')
                .select('*')
                .eq('user_id', currentUser.id)
                .single();

            if (addressError && addressError.code !== 'PGRST116') console.error('Error fetching address:', addressError.message);
            else if (addressData) {
                fullNameInput.value = addressData.full_name || '';
                mobileNumberInput.value = addressData.mobile_number || '';
                pincodeInput.value = addressData.pincode || '';
                addressLine1Input.value = addressData.address_line1 || '';
                addressLine2Input.value = addressData.address_line2 || '';
                cityInput.value = addressData.city || '';
                stateInput.value = addressData.state || '';
            }
        }

        logoutBtn.addEventListener('click', async () => {
            showConfirm("Logout", "Are you sure you want to log out?", async () => {
                const { error } = await supabase.auth.signOut();
                if (error) showAlert("Logout Error", error.message);
                else {
                    showAlert("Logged Out", "You have been logged out.");
                    showScreen('homeScreen');
                }
            });
        });

        // --- Avatar Upload ---
        changeAvatarBtn.addEventListener('click', () => avatarUploadInput.click());

        avatarUploadInput.addEventListener('change', async (event) => {
            if (!currentUser) {
                showAlert("Error", "Please log in to change your avatar.");
                return;
            }
            const file = event.target.files[0];
            if (!file) return;

            const fileExt = file.name.split('.').pop();
            const fileName = `${currentUser.id}.${fileExt}`;
            const filePath = `avatars/${fileName}`;

            try {
                // Upload avatar to Supabase Storage
                const { error: uploadError } = await supabase.storage
                    .from('avatars')
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: true
                    });

                if (uploadError) throw uploadError;

                // Get public URL
                const { data: publicUrlData } = supabase.storage
                    .from('avatars')
                    .getPublicUrl(filePath);

                const avatarUrl = publicUrlData.publicUrl;

                // Update user's avatar_url in 'users' table (and user_metadata for immediate update)
                const { error: updateProfileError } = await supabase
                    .from('users')
                    .upsert({ id: currentUser.id, avatar_url: avatarUrl }, { onConflict: 'id' });

                if (updateProfileError) throw updateProfileError;

                // Update auth.user_metadata directly for current session if possible (Supabase client might not reflect immediately)
                const { data: { user }, error: updateAuthError } = await supabase.auth.updateUser({
                    data: { avatar_url: avatarUrl }
                });

                if (updateAuthError) console.error("Error updating user metadata:", updateAuthError.message);
                else {
                    currentUser.user_metadata.avatar_url = avatarUrl; // Manual update for immediate UI effect
                    profileAvatarDisplay.src = avatarUrl;
                    showAlert("Success", "Avatar updated successfully!");
                }
            } catch (error) {
                showAlert("Upload Error", error.message);
            }
        });

        // --- Fetch & Render Data (Banners, Categories, Products) ---
        async function fetchBanners() {
            const { data, error } = await supabase.from('banners').select('*').order('id', { ascending: true });
            if (error) {
                console.error('Error fetching banners:', error.message);
                return;
            }
            renderBanners(data);
        }

        let currentBannerIndex = 0;
        function renderBanners(banners) {
            bannerSlider.innerHTML = '';
            bannerDots.innerHTML = '';
            banners.forEach((banner, index) => {
                const slide = document.createElement('div');
                slide.className = 'banner-slide';
                slide.style.backgroundImage = `url('${banner.image_url}')`;
                bannerSlider.appendChild(slide);

                const dot = document.createElement('div');
                dot.className = `banner-dot ${index === 0 ? 'active' : ''}`;
                dot.addEventListener('click', () => goToBanner(index));
                bannerDots.appendChild(dot);
            });

            if (banners.length > 0) {
                updateBannerSlider();
                setInterval(() => {
                    currentBannerIndex = (currentBannerIndex + 1) % banners.length;
                    updateBannerSlider();
                }, 5000); // Change banner every 5 seconds
            }
        }

        function updateBannerSlider() {
            const width = bannerSlider.querySelector('.banner-slide').clientWidth;
            bannerSlider.style.transform = `translateX(-${currentBannerIndex * width}px)`;
            bannerDots.querySelectorAll('.banner-dot').forEach((dot, index) => {
                dot.classList.toggle('active', index === currentBannerIndex);
            });
        }

        function goToBanner(index) {
            currentBannerIndex = index;
            updateBannerSlider();
        }

        async function fetchCategories() {
            const { data, error } = await supabase.from('categories').select('*').order('name', { ascending: true });
            if (error) {
                console.error('Error fetching categories:', error.message);
                return;
            }
            renderCategories(data);
            populateFilterCategories(data);
        }

        function renderCategories(categories) {
            categoryGrid.innerHTML = '';
            categories.forEach(category => {
                const card = document.createElement('div');
                card.className = 'category-card';
                card.innerHTML = `
                    <img src="${category.image_url || 'https://via.placeholder.com/60?text=Category'}" alt="${category.name}">
                    <span>${category.name}</span>
                `;
                card.addEventListener('click', () => filterProductsByCategory(category.name));
                categoryGrid.appendChild(card);
            });
        }

        function populateFilterCategories(categories) {
            filterCategorySelect.innerHTML = '<option value="">All Categories</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.name;
                option.textContent = category.name;
                filterCategorySelect.appendChild(option);
            });
            filterCategorySelect.value = currentFilterCategory; // Set selected value if any
        }

        async function fetchProducts() {
            const { data, error } = await supabase.from('products').select('*');
            if (error) {
                console.error('Error fetching products:', error.message);
                return;
            }
            allProducts = data;
            renderProducts(allProducts, productGrid);
        }

        function renderProducts(productsToRender, targetElement) {
            targetElement.innerHTML = '';
            if (productsToRender.length === 0) {
                targetElement.innerHTML = '<p class="text-center">No products to display.</p>';
                return;
            }

            const sortedProducts = [...productsToRender];
            if (currentSortBy === 'price_asc') {
                sortedProducts.sort((a, b) => a.price - b.price);
            } else if (currentSortBy === 'price_desc') {
                sortedProducts.sort((a, b) => b.price - a.price);
            }

            sortedProducts.forEach(product => {
                const isFavorited = userWishlist.some(item => item.product_id === product.id);
                const card = document.createElement('a');
                card.href = "#"; // Prevent default navigation
                card.className = 'product-card';
                card.innerHTML = `
                    <img src="${product.image_urls[0] || 'https://via.placeholder.com/150?text=Product'}" alt="${product.title}">
                    <button class="product-card-heart ${isFavorited ? 'favorited' : ''}" data-product-id="${product.id}">
                        <i class="fas fa-heart"></i>
                    </button>
                    <div class="product-card-info">
                        <span class="product-card-title">${product.title}</span>
                        <span class="product-card-price">₹${product.price.toFixed(2)}</span>
                    </div>
                `;
                card.addEventListener('click', (e) => {
                    if (e.target.closest('.product-card-heart')) {
                        toggleWishlist(product.id);
                    } else {
                        openProductDetails(product.id);
                    }
                });
                targetElement.appendChild(card);
            });
        }

        // --- Search Functionality ---
        searchButton.addEventListener('click', performSearch);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        function performSearch() {
            const searchTerm = searchInput.value.toLowerCase();
            if (searchTerm === '') {
                showScreen('homeScreen');
                return;
            }

            searchTermDisplay.textContent = searchTerm;
            const filteredProducts = allProducts.filter(product =>
                product.title.toLowerCase().includes(searchTerm) ||
                product.description.toLowerCase().includes(searchTerm) ||
                product.category.toLowerCase().includes(searchTerm)
            );

            renderProducts(filteredProducts, searchResultsGrid);
            noSearchResults.classList.toggle('hidden', filteredProducts.length > 0);
            showScreen('searchResultsScreen');
        }

        function filterProductsByCategory(categoryName) {
            currentFilterCategory = categoryName;
            filterCategorySelect.value = categoryName; // Update filter modal state
            applyFiltersAndSort();
            showScreen('homeScreen'); // Go back to home screen with filtered products
        }

        filterSortBtn.addEventListener('click', () => {
            filterSortModal.classList.remove('hidden');
            filterCategorySelect.value = currentFilterCategory;
            sortBySelect.value = currentSortBy;
        });

        filterSortCancelBtn.addEventListener('click', () => {
            filterSortModal.classList.add('hidden');
        });

        filterSortApplyBtn.addEventListener('click', () => {
            currentFilterCategory = filterCategorySelect.value;
            currentSortBy = sortBySelect.value;
            applyFiltersAndSort();
            filterSortModal.classList.add('hidden');
        });

        function applyFiltersAndSort() {
            let filtered = [...allProducts];

            if (currentFilterCategory) {
                filtered = filtered.filter(p => p.category === currentFilterCategory);
            }

            renderProducts(filtered, productGrid);
        }

        // --- Product Details ---
        async function openProductDetails(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) {
                showAlert("Error", "Product not found.");
                return;
            }
            currentProduct = product; // Set current product for other actions

            productDetailName.textContent = product.title;
            productDetailPrice.textContent = `₹${product.price.toFixed(2)}`;
            productDetailDescription.textContent = product.description;

            // Image Slider
            productImageSlider.innerHTML = '';
            productImageDots.innerHTML = '';
            product.image_urls.forEach((url, index) => {
                const slide = document.createElement('div');
                slide.className = 'product-detail-image-slide';
                slide.style.backgroundImage = `url('${url}')`;
                productImageSlider.appendChild(slide);

                const dot = document.createElement('div');
                dot.className = `product-detail-dot ${index === 0 ? 'active' : ''}`;
                dot.addEventListener('click', () => goToProductImage(index));
                productImageDots.appendChild(dot);
            });
            updateProductImageSlider(0); // Initialize slider

            // Sizes
            productDetailSizes.innerHTML = '';
            if (product.sizes && product.sizes.length > 0) {
                product.sizes.forEach((size, index) => {
                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.name = 'productSize';
                    input.id = `size-${size}`;
                    input.value = size;
                    if (index === 0) input.checked = true; // Select first size by default

                    const label = document.createElement('label');
                    label.htmlFor = `size-${size}`;
                    label.textContent = size.toUpperCase();

                    productDetailSizes.appendChild(input);
                    productDetailSizes.appendChild(label);
                });
            } else {
                productDetailSizes.innerHTML = '<p class="text-dark-gray">No specific sizes available.</p>';
            }

            showScreen('productDetailsScreen');
        }

        let currentProductImageIndex = 0;
        function updateProductImageSlider(index) {
            currentProductImageIndex = index;
            const width = productImageSlider.querySelector('.product-detail-image-slide').clientWidth;
            productImageSlider.style.transform = `translateX(-${currentProductImageIndex * width}px)`;
            productImageDots.querySelectorAll('.product-detail-dot').forEach((dot, idx) => {
                dot.classList.toggle('active', idx === currentProductImageIndex);
            });
        }

        function goToProductImage(index) {
            updateProductImageSlider(index);
        }

        tryOnBtn.addEventListener('click', () => {
            if (currentProduct) {
                window.open(`tryon.html?product_id=${currentProduct.id}`, '_blank');
            } else {
                showAlert("Error", "No product selected for try-on.");
            }
        });

        // --- Cart Functionality ---
        addToCartBtn.addEventListener('click', async () => {
            if (!currentUser) {
                showAlert("Login Required", "Please log in to add items to your cart.");
                return;
            }
            if (!currentProduct) {
                showAlert("Error", "No product selected.");
                return;
            }

            const selectedSize = document.querySelector('input[name="productSize"]:checked')?.value || 'N/A';
            if (currentProduct.sizes && currentProduct.sizes.length > 0 && selectedSize === 'N/A') {
                showAlert("Select Size", "Please select a size for the product.");
                return;
            }

            const existingCartItem = userCart.find(item => item.product_id === currentProduct.id && item.size === selectedSize);

            if (existingCartItem) {
                // Update quantity
                const { error } = await supabase
                    .from('carts')
                    .update({ qty: existingCartItem.qty + 1 })
                    .eq('id', existingCartItem.id);
                if (error) showAlert("Error", "Failed to update cart quantity.");
                else {
                    showAlert("Added to Cart", `${currentProduct.title} quantity updated.`);
                    await fetchUserData(); // Re-fetch cart data
                }
            } else {
                // Add new item
                const { error } = await supabase
                    .from('carts')
                    .insert({ user_id: currentUser.id, product_id: currentProduct.id, qty: 1, size: selectedSize });
                if (error) showAlert("Error", "Failed to add product to cart.");
                else {
                    showAlert("Added to Cart", `${currentProduct.title} added to your cart.`);
                    await fetchUserData(); // Re-fetch cart data
                }
            }
        });

        async function updateCartItemQuantity(cartItemId, newQty) {
            if (newQty < 1) return;
            const { error } = await supabase
                .from('carts')
                .update({ qty: newQty })
                .eq('id', cartItemId);
            if (error) showAlert("Error", "Failed to update quantity.");
            else await fetchUserData();
        }

        async function removeCartItem(cartItemId) {
            showConfirm("Remove Item", "Are you sure you want to remove this item from your cart?", async () => {
                const { error } = await supabase
                    .from('carts')
                    .delete()
                    .eq('id', cartItemId);
                if (error) showAlert("Error", "Failed to remove item.");
                else {
                    showAlert("Removed", "Item removed from cart.");
                    await fetchUserData();
                }
            });
        }

        function renderCart() {
            cartItemsContainer.innerHTML = '';
            if (userCart.length === 0) {
                emptyCartMessage.classList.remove('hidden');
                cartSummary.classList.add('hidden');
                return;
            }
            emptyCartMessage.classList.add('hidden');
            cartSummary.classList.remove('hidden');

            let subtotal = 0;
            userCart.forEach(item => {
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.innerHTML = `
                    <img src="${item.product.image_urls[0] || 'https://via.placeholder.com/80?text=Product'}" alt="${item.product.title}">
                    <div class="cart-item-details">
                        <div class="cart-item-title">${item.product.title}</div>
                        <div class="cart-item-price">₹${item.product.price.toFixed(2)} x ${item.qty}</div>
                        ${item.size && item.size !== 'N/A' ? `<div class="text-dark-gray text-sm">Size: ${item.size.toUpperCase()}</div>` : ''}
                    </div>
                    <div class="cart-item-actions">
                        <div class="cart-item-qty-selector">
                            <button data-id="${item.id}" data-action="decrease">-</button>
                            <span>${item.qty}</span>
                            <button data-id="${item.id}" data-action="increase">+</button>
                        </div>
                        <button class="cart-item-remove-btn" data-id="${item.id}"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                cartItemsContainer.appendChild(cartItem);
                subtotal += item.product.price * item.qty;
            });

            cartItemsContainer.querySelectorAll('.cart-item-qty-selector button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = parseInt(e.target.dataset.id);
                    const action = e.target.dataset.action;
                    const item = userCart.find(i => i.id === id);
                    if (item) {
                        const newQty = action === 'increase' ? item.qty + 1 : item.qty - 1;
                        updateCartItemQuantity(id, newQty);
                    }
                });
            });

            cartItemsContainer.querySelectorAll('.cart-item-remove-btn').forEach(button => {
                button.addEventListener('click', (e) => removeCartItem(parseInt(e.currentTarget.dataset.id)));
            });

            cartSubtotal.textContent = `₹${subtotal.toFixed(2)}`;
            const shipping = 50.00; // Fixed shipping for now
            cartTotal.textContent = `₹${(subtotal + shipping).toFixed(2)}`;
        }

        // --- Wishlist Functionality ---
        async function toggleWishlist(productId) {
            if (!currentUser) {
                showAlert("Login Required", "Please log in to add items to your wishlist.");
                return;
            }

            const existingWishlistItem = userWishlist.find(item => item.product_id === productId);

            if (existingWishlistItem) {
                const { error } = await supabase
                    .from('wishlists')
                    .delete()
                    .eq('id', existingWishlistItem.id);
                if (error) showAlert("Error", "Failed to remove from wishlist.");
                else {
                    showAlert("Removed", "Item removed from wishlist.");
                    await fetchUserData();
                    // Re-render current product list to update heart icon
                    renderProducts(allProducts, productGrid);
                    if (document.getElementById('searchResultsScreen').classList.contains('hidden') === false) {
                        performSearch(); // Re-render search results if visible
                    }
                }
            } else {
                const { error } = await supabase
                    .from('wishlists')
                    .insert({ user_id: currentUser.id, product_id: productId });
                if (error) showAlert("Error", "Failed to add to wishlist.");
                else {
                    showAlert("Added to Wishlist", "Item added to your wishlist.");
                    await fetchUserData();
                    // Re-render current product list to update heart icon
                    renderProducts(allProducts, productGrid);
                    if (document.getElementById('searchResultsScreen').classList.contains('hidden') === false) {
                        performSearch(); // Re-render search results if visible
                    }
                }
            }
        }

        function renderWishlist() {
            wishlistGrid.innerHTML = '';
            if (userWishlist.length === 0) {
                emptyWishlistMessage.classList.remove('hidden');
                return;
            }
            emptyWishlistMessage.classList.add('hidden');

            const productsInWishlist = userWishlist.map(item => item.product);
            renderProducts(productsInWishlist, wishlistGrid); // Reuse product rendering for wishlist grid
        }

        // --- Checkout & Payment ---
        buyNowBtn.addEventListener('click', async () => {
            if (!currentUser) {
                showAlert("Login Required", "Please log in to buy this product.");
                return;
            }
            if (!currentProduct) {
                showAlert("Error", "No product selected.");
                return;
            }
            const selectedSize = document.querySelector('input[name="productSize"]:checked')?.value || 'N/A';
            if (currentProduct.sizes && currentProduct.sizes.length > 0 && selectedSize === 'N/A') {
                showAlert("Select Size", "Please select a size for the product.");
                return;
            }
            // For "Buy Now", we create a temporary cart with just this item
            userCart = [{ product_id: currentProduct.id, qty: 1, size: selectedSize, product: currentProduct }];
            renderCart(); // This will update cartTotal for a single item
            showScreen('deliveryAddressScreen');
        });

        checkoutBtn.addEventListener('click', () => {
            if (!currentUser) {
                showAlert("Login Required", "Please log in to proceed to checkout.");
                return;
            }
            if (userCart.length === 0) {
                showAlert("Empty Cart", "Your cart is empty. Add items before checking out.");
                return;
            }
            showScreen('deliveryAddressScreen');
        });

        placeOrderBtn.addEventListener('click', handlePlaceOrder);

        async function handlePlaceOrder() {
            if (!currentUser) {
                showAlert("Error", "User not authenticated.");
                return;
            }

            // Validate address form
            if (!addressForm.checkValidity()) {
                addressForm.reportValidity();
                return;
            }

            const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            const totalAmount = parseFloat(cartTotal.textContent.replace('₹', '')); // Get total from rendered cart summary

            // Save or update address
            const address = {
                user_id: currentUser.id,
                full_name: fullNameInput.value,
                mobile_number: mobileNumberInput.value,
                pincode: pincodeInput.value,
                address_line1: addressLine1Input.value,
                address_line2: addressLine2Input.value,
                city: cityInput.value,
                state: stateInput.value
            };

            const { error: addressSaveError } = await supabase.from('addresses').upsert(address, { onConflict: 'user_id' });
            if (addressSaveError) {
                showAlert("Address Error", "Failed to save address: " + addressSaveError.message);
                return;
            }

            if (selectedPaymentMethod === 'COD') {
                await processOrder('COD', totalAmount);
            } else {
                // Online Payment with Razorpay
                startRazorpayPayment(totalAmount);
            }
        }

        async function startRazorpayPayment(amount) {
            const options = {
                key: RAZORPAY_KEY_ID, // Your Razorpay Key ID
                amount: amount * 100, // Amount in paise (e.g., 50000 for ₹500)
                currency: "INR",
                name: "E-Shop",
                description: "Product Purchase",
                image: "https://via.placeholder.com/100?text=E-Shop",
                handler: async function (response) {
                    // Payment successful, now process the order
                    await processOrder('Online', amount, response.razorpay_payment_id);
                },
                prefill: {
                    name: fullNameInput.value,
                    email: currentUser.email,
                    contact: mobileNumberInput.value
                },
                notes: {
                    address: `${addressLine1Input.value}, ${cityInput.value}`
                },
                theme: {
                    color: "var(--primary)" // Use CSS variable for consistency
                }
            };

            const rzp1 = new Razorpay(options); //
            rzp1.on('payment.failed', function (response) {
                showAlert("Payment Failed", response.error.description);
                console.error("Razorpay Error:", response.error);
            });
            rzp1.open(); //
        }

        async function processOrder(paymentMethod, totalAmount, paymentId = null) {
            if (!currentUser) {
                showAlert("Error", "User not authenticated for order processing.");
                return;
            }

            const orderItems = userCart.map(item => ({
                product_id: item.product.id,
                title: item.product.title,
                price: item.product.price,
                qty: item.qty,
                size: item.size,
                image_url: item.product.image_urls[0]
            }));

            const { data: order, error } = await supabase
                .from('orders')
                .insert({
                    user_id: currentUser.id,
                    items: orderItems,
                    total: totalAmount,
                    status: 'Order Placed',
                    payment_method: paymentMethod,
                    payment_id: paymentId,
                    delivery_address: {
                        full_name: fullNameInput.value,
                        mobile_number: mobileNumberInput.value,
                        pincode: pincodeInput.value,
                        address_line1: addressLine1Input.value,
                        address_line2: addressLine2Input.value,
                        city: cityInput.value,
                        state: stateInput.value
                    }
                })
                .select()
                .single();

            if (error) {
                showAlert("Order Error", "Failed to place order: " + error.message);
                return;
            }

            // Clear cart after successful order
            const { error: clearCartError } = await supabase
                .from('carts')
                .delete()
                .eq('user_id', currentUser.id);

            if (clearCartError) console.error("Error clearing cart:", clearCartError.message);
            
            userCart = []; // Clear local cart
            renderCart(); // Update UI

            confirmedOrderId.textContent = `#${order.id}`;
            showAlert("Order Placed", `Your order #${order.id} has been placed successfully!`);
            showScreen('orderConfirmationScreen');
        }

        // --- My Orders ---
        myOrdersBtn.addEventListener('click', async () => {
            if (!currentUser) {
                showAlert("Login Required", "Please log in to view your orders.");
                return;
            }
            await fetchAndRenderOrders();
            showScreen('myOrdersScreen');
        });

        async function fetchAndRenderOrders() {
            const { data, error } = await supabase
                .from('orders')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error fetching orders:', error.message);
                showAlert("Error", "Failed to fetch your orders.");
                return;
            }

            ordersList.innerHTML = '';
            if (data.length === 0) {
                emptyOrdersMessage.classList.remove('hidden');
                return;
            }
            emptyOrdersMessage.classList.add('hidden');

            data.forEach(order => {
                const orderCard = document.createElement('div');
                orderCard.className = 'profile-section mb-4';
                const totalItems = order.items.reduce((sum, item) => sum + item.qty, 0);
                orderCard.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold">Order #${order.id}</h3>
                        <span class="text-dark-gray text-sm">${new Date(order.created_at).toLocaleDateString()}</span>
                    </div>
                    <p>Total Items: ${totalItems}</p>
                    <p>Total Amount: <span class="font-bold text-primary">₹${order.total.toFixed(2)}</span></p>
                    <p>Status: <span class="font-bold">${order.status}</span></p>
                    <div class="flex justify-end mt-4">
                        <button class="btn btn-sm btn-outline" data-order-id="${order.id}">Track Order</button>
                    </div>
                `;
                ordersList.appendChild(orderCard);
            });

            ordersList.querySelectorAll('.btn-outline').forEach(button => {
                button.addEventListener('click', (e) => trackOrder(parseInt(e.currentTarget.dataset.orderId)));
            });
        }

        async function trackOrder(orderId) {
            const { data: order, error } = await supabase
                .from('orders')
                .select('*')
                .eq('id', orderId)
                .eq('user_id', currentUser.id)
                .single();

            if (error) {
                showAlert("Error", "Failed to fetch order details.");
                console.error(error);
                return;
            }

            trackOrderIdDisplay.textContent = `#${order.id}`;
            renderOrderTimeline(order.status, order.created_at);
            cancelOrderSection.classList.toggle('hidden', order.status === 'Cancelled' || order.status === 'Delivered');
            cancelOrderBtn.dataset.orderId = order.id;

            showScreen('trackOrderScreen');
        }

        const orderStatuses = ['Order Placed', 'In Progress', 'Shipped', 'Delivered', 'Cancelled'];

        function renderOrderTimeline(currentStatus, createdAt) {
            orderTimeline.innerHTML = '';
            const statusIndex = orderStatuses.indexOf(currentStatus);

            orderStatuses.forEach((status, index) => {
                const item = document.createElement('div');
                item.className = `timeline-item ${index <= statusIndex ? 'active' : ''}`;
                item.innerHTML = `
                    <div class="timeline-item-title">${status}</div>
                    <div class="timeline-item-date">${index === 0 ? new Date(createdAt).toLocaleString() : ''}</div>
                `;
                orderTimeline.appendChild(item);
            });
        }

        cancelOrderBtn.addEventListener('click', (e) => {
            const orderId = parseInt(e.currentTarget.dataset.orderId);
            showConfirm("Cancel Order", "Are you sure you want to cancel this order?", async () => {
                const { error } = await supabase
                    .from('orders')
                    .update({ status: 'Cancelled' })
                    .eq('id', orderId)
                    .eq('user_id', currentUser.id);

                if (error) {
                    showAlert("Error", "Failed to cancel order: " + error.message);
                } else {
                    showAlert("Success", "Order cancelled successfully!");
                    trackOrder(orderId); // Refresh timeline
                }
            });
        });

        // --- Address Management ---
        manageAddressBtn.addEventListener('click', () => {
            if (!currentUser) {
                showAlert("Login Required", "Please log in to manage your address.");
                return;
            }
            showScreen('deliveryAddressScreen'); // Reuse delivery screen for address management
        });

        pincodeInput.addEventListener('input', async () => {
            const pincode = pincodeInput.value;
            if (pincode.length === 6) {
                try {
                    const response = await fetch(`https://api.postalpincode.in/pincode/${pincode}`);
                    const data = await response.json();
                    if (data && data[0] && data[0].Status === 'Success' && data[0].PostOffice.length > 0) {
                        const postOffice = data[0].PostOffice[0];
                        cityInput.value = postOffice.District;
                        stateInput.value = postOffice.State;
                    } else {
                        cityInput.value = '';
                        stateInput.value = '';
                        showAlert("Pincode Error", "Invalid Pincode or no data found.");
                    }
                } catch (error) {
                    console.error('Pincode API error:', error);
                    cityInput.value = '';
                    stateInput.value = '';
                    showAlert("Error", "Could not fetch city/state for the given pincode.");
                }
            } else {
                cityInput.value = '';
                stateInput.value = '';
            }
        });

        addressForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) {
                showAlert("Error", "User not authenticated.");
                return;
            }
            const address = {
                user_id: currentUser.id,
                full_name: fullNameInput.value,
                mobile_number: mobileNumberInput.value,
                pincode: pincodeInput.value,
                address_line1: addressLine1Input.value,
                address_line2: addressLine2Input.value,
                city: cityInput.value,
                state: stateInput.value
            };
            const { error } = await supabase.from('addresses').upsert(address, { onConflict: 'user_id' });
            if (error) {
                showAlert("Error", "Failed to save address: " + error.message);
            } else {
                showAlert("Success", "Address saved successfully!");
                showScreen('profileScreen');
            }
        });

        // --- Contact Us (Placeholder) ---
        contactUsBtn.addEventListener('click', () => {
            showAlert("Contact Us", "For support, please email us at support@eshop.com or call +91-1234567890.");
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', async () => {
            await fetchBanners();
            await fetchCategories();
            await fetchProducts();
            await supabase.auth.getSession(); // This will trigger onAuthStateChange
            updateAuthUI();
            showScreen('homeScreen');
        });

        // --- Bottom Navigation Event Listeners ---
        document.getElementById('navHome').addEventListener('click', (e) => { e.preventDefault(); showScreen('homeScreen'); });
        document.getElementById('navWishlist').addEventListener('click', (e) => { e.preventDefault(); if (currentUser) showScreen('favoritesScreen'); else showAlert("Login Required", "Please log in to view your wishlist."); });
        document.getElementById('navCart').addEventListener('click', (e) => { e.preventDefault(); if (currentUser) showScreen('cartScreen'); else showAlert("Login Required", "Please log in to view your cart."); });
        document.getElementById('navProfile').addEventListener('click', (e) => { e.preventDefault(); showScreen('profileScreen'); });

    </script>
</body>
</html>